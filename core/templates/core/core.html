{% extends 'base_core.html' %} 
{% load static %} 
{% load coretags %} 

{% block content %}
<div class="body">
  
  <div class="header">
    <h3 style="text-align: center; color: white; margin: 40px 0; font-size: 2.5rem;">
      üìö –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã
    </h3>
  </div>
<div class="search-section">
    <form action="{% url 'core' %}" method="get" class="search-box">
        <div class="search-inner">
            <input style="text-decoration: none; text-align: center;" type="text" name="q" placeholder="üîç –ù–∞–π—Ç–∏ –ø–æ—Å—Ç –∏–ª–∏ –∞–≤—Ç–æ—Ä–∞..." value="{{ search_query|default:'' }}" autocomplete="off">
            {% if search_query %}
                <a href="{% url 'core' %}" class="clear-search">‚úï</a>
            {% endif %}
        </div>
    </form>
</div>

<div id="categories-wrapper">
    <div class="categories-container">
        <ul class="categories-list">
            {% if cat_selected == 0 %}
                <li class="category-item selected" id="all-cats-btn">
                    <span>–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                </li>
            {% else %}
                <li class="category-item" id="all-cats-btn">
                    <a href="{% url 'core' %}" class="category-link-full">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
                </li>
            {% endif %} 
            
            {% show_categories cat_selected %}
        </ul>
        <a class="addpost" href="{% url 'add_post' %}">+</a>
    </div>
</div>

  <div id="posts-wrapper">
    
      <div class="container">
        
        {% if posts %}
            {% for p in posts %}
            <a href="{{ p.get_absolute_url }}" class="post-a">
              <div class="content {% if p.is_pinned %}pinned-style{% endif %}">
                <div class="pin-management-layer">
                {% if p.is_pinned %}
                    <span class="pin-badge" title="–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ">üìå</span>
                {% endif %}
{% if user.is_staff or user.is_superuser %}
    <object style="    background: #00000000;">
        <a href="{% url 'toggle_pin' p.id %}" 
           class="pin-button" 
           onclick="togglePinAjax(event, this)">
            {% if p.is_pinned %} –û—Ç–∫—Ä–µ–ø–∏—Ç—å {% else %} –ó–∞–∫—Ä–µ–ø–∏—Ç—å {% endif %}
        </a>
    </object>
{% endif %}
            </div>
                <div class="post-media-area">
                    {% if p.photo %}
                        <img class="thumb-contain" src="{{ p.photo.url }}" alt="{{ p.title }}">
                    {% elif p.file %}
                        <div class="file-center-badge">
                            <p class="file-p">üìé –§–∞–π–ª: {{ p.file.name|truncatechars:20 }}</p>
                        </div>
                    {% else %}
                        <div class="no-media-placeholder">
                            <span class="placeholder-icon">üì∑</span>
                            <p>–ù–µ—Ç –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤</p>
                        </div>
                    {% endif %}
                </div>

                <div class="post-info-area">
                    
                    <h2 class="post-title">{{ p.title }}</h2>
                    <p class="post-content">{{ p.content|truncatechars:15 }}</p>
                </div>

                <div class="article-panel">
                    <p class="first">
                        <span class="cat-badge">{{p.cat.name}}</span> | 
                        <img class="avatarka-core" src="{% if p.author.photo %}{{ p.author.photo.url }}{% else %}/media/users/default.png{% endif %}" alt="">
                        {{p.author.username}}
                    </p>
                    <p class="last">{{ p.time_create|date:"d-m-Y" }}</p>
                </div>
              </div>
            </a>
            {% endfor %}
        {% else %}
            <div class="no-results">
                <div class="no-results-content">
                    <div class="no-results-icon">üõ∞Ô∏è</div>
                    <h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏...</h3>
                    <p>–ü–æ –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.</p>
                </div>
            </div>
        {% endif %}
      </div>

      <div id="pagination-wrapper">
          {% if page_obj.has_other_pages %}
            <nav class="list-pages">
              <ul>
                {% if page_obj.has_previous %}
                    <li class="page-num">
                        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}"> &lt; </a>
                    </li>
                {% endif %}

                {% for p in paginator.page_range %}
                    {% if page_obj.number == p %}
                        <li class="page-num page-num-selcted">{{ p }}</li>
                    {% elif p >= page_obj.number|add:-2 and p <= page_obj.number|add:2 %}
                        <li class="page-num">
                            <a href="?page={{ p }}{% if search_query %}&q={{ search_query }}{% endif %}">{{ p }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <li class="page-num">
                        <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}"> &gt; </a>
                    </li>
                {% endif %}
              </ul>
            </nav>
          {% endif %}
      </div>
  </div>
</div>

<script>
    // –í—ã–Ω–æ—Å–∏–º —Ñ—É–Ω–∫—Ü–∏—é –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å, —á—Ç–æ–±—ã onclick –µ—ë –≤–∏–¥–µ–ª
function togglePinAjax(event, element) {
    event.preventDefault();
    event.stopPropagation();

    const url = element.getAttribute('href');
    const card = element.closest('.content');
    if (card) card.style.opacity = '0.5';

    fetch(url, {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => {
        // –ú—ã –≤—ã–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é handleAjax
        // –ù–æ —Ç–∞–∫ –∫–∞–∫ handleAjax –≤–Ω—É—Ç—Ä–∏ DOMContentLoaded, –º—ã –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ –Ω–µ–π —Ç–∞–∫:
        window.refreshPosts(); 
    })
    .catch(err => {
        console.error('–û—à–∏–±–∫–∞:', err);
        if (card) card.style.opacity = '1';
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // –î–µ–ª–∞–µ–º handleAjax –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã togglePinAjax –º–æ–≥ –µ—ë –≤—ã–∑–≤–∞—Ç—å
    window.refreshPosts = function() {
        handleAjax(window.location.href);
    };

    // --- –¢–í–û–Ø –õ–û–ì–ò–ö–ê –ñ–ò–í–û–ì–û –ü–û–ò–°–ö–ê ---
    const searchInput = document.querySelector('input[name="q"]');
    let searchTimeout;
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const url = `{% url 'core' %}?q=${encodeURIComponent(searchInput.value)}`;
                handleAjax(url);
            }, 500);
        });
    }

    // --- –û–ë–†–ê–ë–û–¢–ö–ê –ö–õ–ò–ö–û–í (–ö–ê–¢–ï–ì–û–†–ò–ò –ò –ü–ê–ì–ò–ù–ê–¶–ò–Ø) ---
    document.addEventListener('click', function(e) {
        const targetLink = e.target.closest('.category-link-full, .page-num a, .reset-search-btn');
        if (targetLink) {
            e.preventDefault();
            handleAjax(targetLink.href);
        }
    });

    // --- –¢–í–û–Ø –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø AJAX (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ---
    function handleAjax(url) {
        const postsBlock = document.getElementById('posts-wrapper');
        const catsBlock = document.getElementById('categories-wrapper');
        
        postsBlock.style.opacity = '0.3';
        postsBlock.style.pointerEvents = 'none';

        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const newDoc = parser.parseFromString(html, 'text/html');

            const newPostsHtml = newDoc.getElementById('posts-wrapper').innerHTML;
            const newCatsHtml = newDoc.getElementById('categories-wrapper').innerHTML;

            postsBlock.innerHTML = newPostsHtml;
            catsBlock.innerHTML = newCatsHtml;

            postsBlock.style.opacity = '1';
            postsBlock.style.pointerEvents = 'auto';
            
            window.history.pushState({}, '', url);

            // –°–∫—Ä–æ–ª–ª–∏–º –≤–≤–µ—Ä—Ö —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ–∏—Å–∫
            if (!event || (event.target && event.target.name !== 'q')) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        })
        .catch(err => {
            console.error('–û—à–∏–±–∫–∞ AJAX:', err);
            postsBlock.style.opacity = '1';
        });
    }
});
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. –õ–û–ì–ò–ö–ê –ñ–ò–í–û–ì–û –ü–û–ò–°–ö–ê ---
    const searchInput = document.querySelector('input[name="q"]');
    let searchTimeout;

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = searchInput.value;
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –ø–æ–∏—Å–∫–∞
                const url = `{% url 'core' %}?q=${encodeURIComponent(query)}`;
                handleAjax(url);
            }, 500); // –ó–∞–¥–µ—Ä–∂–∫–∞ 0.5 —Å–µ–∫
        });
    }

    // --- 2. –û–ë–†–ê–ë–û–¢–ö–ê –ö–õ–ò–ö–û–í (AJAX) ---
    document.addEventListener('click', function(e) {
        const targetLink = e.target.closest('.category-link-full, .page-num a, .reset-search-btn');
        if (targetLink) {
            e.preventDefault();
            handleAjax(targetLink.href);
        }
    });

    // --- 3. –î–í–û–ô–ù–û–ô –ö–õ–ò–ö ---
    document.addEventListener('dblclick', function(e) {
        const allCatsBtn = e.target.closest('#all-cats-btn');
        if (allCatsBtn) {
            e.preventDefault();
            handleAjax("{% url 'core' %}?show_all=1");
        }
    });


    

    // --- 4. –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø AJAX ---
    function handleAjax(url) {
        const postsBlock = document.getElementById('posts-wrapper');
        const catsBlock = document.getElementById('categories-wrapper');
        
        postsBlock.style.opacity = '0.3';
        postsBlock.style.pointerEvents = 'none';

        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const newDoc = parser.parseFromString(html, 'text/html');

            const newPostsHtml = newDoc.getElementById('posts-wrapper').innerHTML;
            const newCatsHtml = newDoc.getElementById('categories-wrapper').innerHTML;

            postsBlock.innerHTML = newPostsHtml;
            catsBlock.innerHTML = newCatsHtml;

            postsBlock.style.opacity = '1';
            postsBlock.style.pointerEvents = 'auto';
            
            window.history.pushState({}, '', url);

            // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –±—ã–ª –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω –≤–≤–æ–¥–æ–º —Ç–µ–∫—Å—Ç–∞, –ø—Ä–æ–∫—Ä—É—Ç–∫—É –ª—É—á—à–µ –Ω–µ –¥–µ–ª–∞—Ç—å,
            // —á—Ç–æ–±—ã —Ñ–æ–∫—É—Å –Ω–µ –ø—Ä—ã–≥–∞–ª. –ï—Å–ª–∏ –∫–ª–∏–∫–æ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî —Å–∫—Ä–æ–ª–ª–∏–º –≤–≤–µ—Ä—Ö.
            if (!event || event.type !== 'input') {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        })
        .catch(err => {
            console.error('–û—à–∏–±–∫–∞ AJAX:', err);
            postsBlock.style.opacity = '1';
        });
    }
});
</script>
{% endblock %}
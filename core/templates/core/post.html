{% load static %} 
{% load coretags %} 
<!DOCTYPE html> 
<html lang="ru"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>{{ title }}</title> 
    <link rel="icon" href="{% static 'core/images/bolt.png' %}"> 
    <link type="text/css" href="{% static 'core/css_core/post.css' %}" rel="stylesheet"/> 
</head> 
<body> 
    <div class="back-button-container"> 
        <a href="/core" class="back-button"> 
            <span class="back-arrow">‚Üê</span> –ù–∞–∑–∞–¥ –∫ —Å—Ç–∞—Ç—å—è–º 
        </a> 
        {% if perms.core.change_post %} 
            <a class="back-button" href="{% url 'editpage' post.slug %}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a> 
        {% endif %} 
    </div> 

    <div class="post-container"> 
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ --> 
        <header class="post-header" style="display: flex; justify-content: space-between;"> 
            <h1 id="post-title" data-slug="{{ post.slug }}">
    {{ post.title }}
</h1> 
         
           <div class="post-meta"> 
       {% if post.cat %} 
                    <span class="post-category"> 
                        <a href="{% url 'category' post.cat.slug %}" style="text-decoration:none;color:wheat;"> üè∑Ô∏è {{ post.cat.name }} </a> 
                    </span> 
                {% endif %} 
                {% if post.author and post.author.username %} 
                    <span class=""> 
                        <a class="name-post" href="{% url 'user_posts' post.author.username %}" style="text-decoration:none;color:wheat;"> 
                            {% if post.author.photo %} 
                                <img class="avatarka-core" src="{{ post.author.photo.url }}" alt=""> 
                            {% else %} 
                                <img class="avatarka-core" src="/media/users/default.png" alt=""> 
                            {% endif %} 
                            {{ post.author.username }} 

                        </a> 
                    </span> 
                {% else %} 
                    <span class="post-category">–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω</span> 
                {% endif %} 
            </div> 
        </header> 

        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ --> 
        {% if post.photo %} 
            <div class="image-float-left"> 
                <div class="post-image-wrap"> 
                    <img src="{{ post.photo.url }}" alt="{{ post.title }}"> 
                    {% if post.photo_caption %} 
                        <p class="image-caption-wrap">{{ post.photo_caption }}</p> 
                    {% endif %} 
                </div> 
            </div> 
        {% endif %} 

        <!-- –§–∞–π–ª --> 
        {% if post.file %} 
            <div class="post-file"> üìé –§–∞–π–ª: <a href="{{ post.file.url }}" target="_blank">{{ post.file.name|truncatechars:50 }}</a> –°–∫–∞—á–∞—Ç—å </div> 
        {% endif %} 

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç --> 
        <div class="post-content"> 
            {{ post.content|linebreaks }} 
        </div> 


    </div> 
                        {% if post.time_create %} 
                    <span class="post-date">üìÖ {{ post.time_create|date:"d E Y H:i" }}</span> 
                {% endif %} 
    <!-- ===== MODAL COMMENTS ===== --> 
    <div id="commentsModal" class="modal-overlay"> 
        <div class="modal-content" id="modalContent"> 
            <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3> 
            <div class="modal-comments"> 
                {% for comment in comments %} 
                    {% include 'core/includes/comment.html' %} 
                {% empty %} 
                    <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p> 
                {% endfor %} 
            </div> 

            {% if user.is_authenticated %} 
                <hr> 
                <h9 style="font-size: 12px;">–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h9> 
                <form method="post" id="comment-form"> 
                    {% csrf_token %} 
                    {{ form.as_p }} 
                    <input type="hidden" name="parent_id" id="parent_id">
                    <button type="submit" style="display:none;"></button> 
                    <button type="button" id="cancel-reply" style="display:none;">
    –û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç
</button>

                </form> 
            {% else %} 
                <p>–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</p> 
            {% endif %} 
        </div> 
    </div> 

    <!-- –î–µ–π—Å—Ç–≤–∏—è --> 
    <div class="post-actions"> 
        <button class="share-button" onclick="sharePost()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button> 
        <button class="print-button" onclick="printSimple()">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å</button> 
        <button class="comment-button" onclick="openComments()">üí¨ ({{ comments|length }})–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ </button> 
    </div> 

    <!-- ================= JS ================= --> 
    <script> 
    document.addEventListener("DOMContentLoaded", function() { 
        const commentContainer = document.querySelector(".modal-comments"); 

        // ===== –§—É–Ω–∫—Ü–∏—è –ª–∞–π–∫–∞ ===== 
        function attachLike(btn) { 
            btn.addEventListener("click", function() { 
                const commentId = this.dataset.id; 
                const heart = this.closest(".comment").querySelector(".heart-animation");

                // –ü–æ–∫–∞–∑ –∞–Ω–∏–º–∞—Ü–∏–∏ —Å–µ—Ä–¥—Ü–∞ —Å—Ä–∞–∑—É
                if (heart) {
                    heart.style.display = "inline";
                    heart.classList.remove("pop");
                    void heart.offsetWidth;
                    heart.classList.add("pop");
                    setTimeout(() => { heart.style.display = "none"; }, 600);
                }

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–∞–π–∫–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
                fetch("{% url 'like_comment' %}", { 
                    method: "POST", 
                    headers: { 
                        "X-CSRFToken": "{{ csrf_token }}", 
                        "Content-Type": "application/x-www-form-urlencoded" 
                    }, 
                    body: "comment_id=" + commentId 
                }) 
                .then(response => response.json()) 
                .then(data => { 
                    document.getElementById("likes-" + commentId).innerText = (data.total_likes > 0 ? "‚ù§Ô∏è" + data.total_likes : ""); 
                }); 
            }); 
        }

        // ===== –û—Ç–≤–µ—Ç –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π =====
        document.addEventListener("click", function(e) {

            if (e.target.classList.contains("reply-btn")) {

                const commentId = e.target.dataset.id;
                const username = e.target.dataset.username;

                const textarea = document.querySelector("#comment-form textarea");
                const parentInput = document.getElementById("parent_id");
                const cancelBtn = document.getElementById("cancel-reply");

                parentInput.value = commentId;
                textarea.value = "@" + username + " ";
                textarea.focus();

                cancelBtn.style.display = "inline-block";

                // üîÑ –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
                textarea.scrollIntoView({
                    behavior: "smooth",
                    block: "center"
                });

                document.getElementById("commentsModal").classList.add("active");
            }
        });

        // ‚ùå –û—Ç–º–µ–Ω–∞ –æ—Ç–≤–µ—Ç–∞
        document.getElementById("cancel-reply").addEventListener("click", function() {
            document.getElementById("parent_id").value = "";
            document.querySelector("#comment-form textarea").value = "";
            this.style.display = "none";
        });

        

        // ===== –î–∞–±–ª —Ç–∞–ø / –¥–∞–±–ª –∫–ª–∏–∫ –¥–ª—è –ª–∞–π–∫–∞ =====
        function attachDoubleTap(commentElement) {
            let lastTap = 0;

            commentElement.addEventListener("touchend", function(e) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 300 && tapLength > 0) {
                    const likeBtn = commentElement.querySelector(".like-btn");
                    if (likeBtn) likeBtn.click(); // —Ç–µ–ø–µ—Ä—å —Å—Ä–∞–∑—É –∞–Ω–∏–º–∞—Ü–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∏—Å–ª–∞
                }
                lastTap = currentTime;
            });

            commentElement.addEventListener("dblclick", function() {
                const likeBtn = commentElement.querySelector(".like-btn");
                if (likeBtn) likeBtn.click();
            });
        }


        // –ü—Ä–∏–≤—è–∑–∫–∞ –ª–∞–π–∫–æ–≤ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º
        document.querySelectorAll(".like-btn").forEach(attachLike);
        document.querySelectorAll(".comment").forEach(attachDoubleTap);

        // ===== –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —á–µ—Ä–µ–∑ AJAX ===== 
        commentContainer.addEventListener("click", function(e) { 
            if (e.target.classList.contains('delete-comment-btn')) { 
                e.preventDefault(); 
                const url = e.target.href; 
                const commentDiv = e.target.closest(".comment"); 
                fetch(url, { 
                    method: "POST", 
                    headers: { 
                        "X-CSRFToken": "{{ csrf_token }}", 
                        "X-Requested-With": "XMLHttpRequest" 
                    }, 
                    credentials: "same-origin" 
                }) 
                .then(response => response.json()) 
                .then(data => { 
                    if (data.success) commentDiv.remove(); 
                    else alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è"); 
                }) 
                .catch(() => alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è")); 
            } 
        }); 

        // ===== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —á–µ—Ä–µ–∑ AJAX ===== 
        const commentForm = document.getElementById("comment-form"); 
        if (commentForm) { 
            const textarea = commentForm.querySelector("textarea"); 
            textarea.addEventListener("keydown", function(e) { 
                if (e.key === "Enter" && !e.shiftKey) { 
                    e.preventDefault(); 
                    commentForm.dispatchEvent(new Event('submit', { cancelable: true })); 
                } 
            }); 
            commentForm.addEventListener("submit", function(e) { 
    e.preventDefault(); 
    const formData = new FormData(this); 
    const parentId = document.getElementById("parent_id").value; // –ü–æ–ª—É—á–∞–µ–º ID —Ä–æ–¥–∏—Ç–µ–ª—è –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è

    fetch("", { 
        method: "POST", 
        headers: { 
            "X-Requested-With": "XMLHttpRequest", 
            "X-CSRFToken": "{{ csrf_token }}" 
        }, 
        body: formData 
    }) 
    .then(response => response.json()) 
    .then(data => { 
        if (data.error) return; 

        if (parentId) {
            // 1. –ò—â–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ data-id –∫–Ω–æ–ø–∫–∏ "–õ–∞–π–∫" –∏–ª–∏ –ø–æ –¥—Ä—É–≥–æ–º—É –ø—Ä–∏–∑–Ω–∞–∫—É
            const parentBtn = document.querySelector(`.like-btn[data-id="${parentId}"]`);
            const parentCommentDiv = parentBtn.closest('.comment');

            // 2. –°–æ–∑–¥–∞–µ–º –æ–±–µ—Ä—Ç–∫—É –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ (–∫–ª–∞—Å—Å .reply –∫–∞–∫ –≤ —Ç–≤–æ–µ–º HTML)
            const replyWrapper = document.createElement('div');
            replyWrapper.className = 'reply';
            replyWrapper.innerHTML = data.html;

            // 3. –í—Å—Ç–∞–≤–ª—è–µ–º –°–†–ê–ó–£ –ø–æ—Å–ª–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –±–ª–æ–∫–∞ .comment
            parentCommentDiv.after(replyWrapper);
        } else {
            // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –æ—Ç–≤–µ—Ç, –∞ –Ω–æ–≤—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            commentContainer.insertAdjacentHTML('afterbegin', data.html); 
        }

        // –û—á–∏—Å—Ç–∫–∞ –∏ —Å–±—Ä–æ—Å
        commentForm.reset(); 
        document.getElementById("parent_id").value = "";
        document.getElementById("cancel-reply").style.display = "none";

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞ (–ª–∞–π–∫–∏ –∏ —Ç.–¥.)
        const addedElement = parentId 
            ? document.querySelector(`.like-btn[data-id="${parentId}"]`).closest('.comment').nextElementSibling 
            : commentContainer.querySelector(".comment:first-child");
        
        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∫ –Ω–æ–≤–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
        const newLikeBtn = addedElement.querySelector(".like-btn");
        if (newLikeBtn) attachLike(newLikeBtn);
        attachDoubleTap(addedElement);
    }); 
});
        } 

        // ===== –ú–æ–¥–∞–ª–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ ===== 
        window.openComments = function() { 
            document.getElementById("commentsModal").classList.add("active"); 
        } 
        document.addEventListener("click", function(e) { 
            const modal = document.getElementById("commentsModal"); 
            const content = document.getElementById("modalContent"); 
            if (modal.classList.contains("active") && !content.contains(e.target) && !e.target.classList.contains("comment-button")) { 
                modal.classList.remove("active"); 
            } 
        }); 
    }); 

    // ===== –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø–æ—Å—Ç–æ–º ===== 
    function sharePost() { 
        if (navigator.share) { 
            navigator.share({ 
                title: '{{ post.title }}', 
                text: '{{ post.content|truncatewords:30|striptags }}', 
                url: window.location.href, 
            }); 
        } else { 
            navigator.clipboard.writeText(window.location.href); 
            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'); 
        } 
    } 

    // ===== –ü–µ—á–∞—Ç—å –ø–æ—Å—Ç–∞ ===== 
function printSimple() {
    // 1. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
    const title = document.getElementById('post-title')?.innerText || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    const content = document.querySelector('.post-content')?.innerText || '';
    const date = document.querySelector('.post-date')?.innerText || '';
    const author = document.querySelector('.name-post')?.innerText.trim() || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
    const category = document.querySelector('.post-category')?.innerText.trim() || '';
    const photo = document.querySelector('.post-image-wrap img')?.src;

    // 2. –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞
    const printWindow = window.open('', '_blank', 'height=600,width=800');

    // 3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    printWindow.document.write('<html><head><title>–ü–µ—á–∞—Ç—å</title>');
    printWindow.document.write('<style>');
    printWindow.document.write(`
        body { 
            font-family: "Times New Roman", Times, serif; 
            padding: 30px; 
            color: #000; 
            line-height: 1.5; 
            background: #fff;
        }
        .print-header { 
            border-bottom: 2px solid #000; 
            margin-bottom: 20px; 
            padding-bottom: 10px; 
        }
        h1 { font-size: 22pt; margin: 0 0 5px 0; }
        .meta { font-size: 10pt; color: #444; margin-bottom: 15px; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–±—Ç–µ–∫–∞–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
        .post-img { 
            float: left;            /* –ü—Ä–∏–∂–∏–º–∞–µ–º –∫ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
            max-width: 40%;         /* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–µ –±–æ–ª–µ–µ 40% —à–∏—Ä–∏–Ω—ã –ª–∏—Å—Ç–∞ */
            height: auto; 
            margin: 0 20px 15px 0;  /* –û—Ç—Å—Ç—É–ø—ã: —Å–ø—Ä–∞–≤–∞ –∏ —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª */
            border: 1px solid #eee;
        }
        
        .content { 
            font-size: 12pt; 
            text-align: justify;    /* –†–æ–≤–Ω—ã–π –∫—Ä–∞–π —Ç–µ–∫—Å—Ç–∞ (–∫–Ω–∏–∂–Ω—ã–π —Å—Ç–∏–ª—å) */
            white-space: pre-wrap;  /* –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –∏–∑ Django */
        }
        
        /* –û—á–∏—Å—Ç–∫–∞ –ø–æ—Ç–æ–∫–∞, —á—Ç–æ–±—ã —Ñ—É—Ç–µ—Ä –Ω–µ –∑–∞–ª–µ–∑ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É */
        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }
        
        .footer { 
            margin-top: 30px; 
            border-top: 1px solid #ccc; 
            padding-top: 10px; 
            font-size: 8pt; 
            color: #777; 
            clear: both; 
        }
    `);
    printWindow.document.write('</style></head><body>');

    // –ö–æ–Ω—Ç–µ–Ω—Ç
    printWindow.document.write('<div class="print-header">');
    printWindow.document.write(`<h1>${title}</h1>`);
    printWindow.document.write(`<div class="meta">${category} | –ê–≤—Ç–æ—Ä: ${author} | ${date}</div>`);
    printWindow.document.write('</div>');

    printWindow.document.write('<div class="clearfix">'); // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –æ—á–∏—Å—Ç–∫–æ–π —Ñ–ª–æ–∞—Ç–∞
    
    if (photo) {
        printWindow.document.write(`<img src="${photo}" class="post-img">`);
    }

    printWindow.document.write(`<div class="content">${content}</div>`);
    printWindow.document.write('</div>'); // –∫–æ–Ω–µ—Ü clearfix
    
    printWindow.document.write(`<div class="footer">–ò—Å—Ç–æ—á–Ω–∏–∫: Vault AI ‚Äî ${window.location.href}</div>`);

    printWindow.document.write('</body></html>');

    // 4. –ü–µ—á–∞—Ç—å
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 450);
}

    document.addEventListener("click", function(e) { 
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é 
        if (e.target.closest(".burger")) { 
            const menu = e.target.closest(".comment-menu"); 
            document.querySelectorAll(".comment-menu").forEach(m => { 
                if (m !== menu) m.classList.remove("active"); 
            }); 
            menu.classList.toggle("active"); 
            return; 
        } 
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ 
        if (!e.target.closest(".comment-menu")) { 
            document.querySelectorAll(".comment-menu").forEach(m => m.classList.remove("active")); 
        } 
    }); 


    

    </script> 
</body> 
</html>
